# OpenCV を使ってTello のカメラにアクセスする
　Tello に搭載された前方、下方カメラは、本ライブラリを使うことでアクセスすることができる。ここでは、OpenCV を使った Tello カメラのアクセス方法、それらを応用したタスクを紹介する。
## 01 sample_video.py の実行
　このディレクトリに sample_video を用意した。このプログラムは実際に Tello のカメラにアクセスし、カメラニューを表示させるものである。ウィンドウをクリックし、ESCキーを押すと、このプログラムは停止するようになっている。以下のコマンドでプログラムを実行させてみよう。
```bash
$ python3 sample_video.py
```
このプログラムがどのように実行されているか理解することは、今後のw学習において非常に重要である。このセクションでは、本プログラムがどのように動いているのかを詳しく解説する。
<br>
　まずは、gedit コマンドで、sample_video.py の内部を除いてみよう。簡単にコメント文で書くプログラムを解説している。
```bash
$ gedit sample_video.py
```
コメント文の内容を見て理解できたなら、あなたはこのまま次のセクションに回ってもらって構わない。理解できなかった方は、引き続き以下のドキュメントを読み続けてほしい。
<br>
　work_space でドローンのプログラムを組んだ方ならあらかた理解しているだろうモジュールのインポートだが、今回新たにインポートしなければならない要素がある。
```python
from tello import console
import cv2
```
　下の cv2 というのが、openCV である。実は tello.py にも openCV はインポートされている。
```python
import re
import socket
import threading
import numpy as np
import time
import cv2 # < ここにある。
import sys
```
　ではなぜまたここにも cv2 をインポートしなければならないのか、それは利便性を上げるためである。本気を出せば、関数一つでドローンからビデオデータを取得し、それをウィンドウに表示させることもできるのだが、今後このライブラリを活用してもらうにおいて、それはとても汎用性の低いものとなってしまうからである。そのため、実行プログラムにも cv2 をインポートしてもらいさらに発展したプログラムを作レルようにしたのである。要するに**めんどくさかった。**
<br>
　冗談は置いといて、次に移ろう。インポート文の下にはこんなものが並んでいる。
```python
def main(): # メイン関数
    drone = console() # console クラスを有効化
    while True:
```
まず、main 関数が定義され、そこにメインプログラムが記述されているのがわかるだろう。なんでこんなよくわからない記述をしているのかについて解説する。
<br>
　このメイン関数を定義してこの中にメインプログラムを書くヒントは、sample_video.py の一番下にある。一番下にこのようなプログラムが書かれているのがわかるだろう。
```python
if __name__ == "__main__": # このプログラムが外部から実行されないようにするおまじない
    main() # メインを実行
    del console # クラスのデストラクタを実行
```
　これは外部プログラムが本プログラムをモジュールとしてインポートされることを防ぐプログラムである。詳細な説明は省くが、一番下にこのようなプログラムを記述されることで、例えば sample_video.py が外部プログラムから実行されるのを防いでくれる。今後大きなプログラムを書く際。このおまじないを使えば安全性が高くなる。覚えておいて損はない。
<br>
　次に console を定義して、活性化をおこなったのちに、while 文があるのがわかるだろう。では、while 文を覗いてみよう。
```python
    while True:
        frame = drone.frame # このデータにドローンからのビデオデータが入っている。
        if frame is None or frame.size == 0: # フレームデータがない、またはフレームのサイズが0の時は無視する
            continue
        cv2.imshow("TELLO CAMERA VIEW",frame) # ビデオを画面出力
        key = cv2.waitKey(1)
        if key & 0xFF == 27: # ESC キーが押されたら終了
            break
```
　while True: すなわち永久ループという意味である。この while 文内のプログラムは常にループ実行されることを意味している。ではなぜ永久ループされるのかを説明しよう。
<br>
　このプログラムは先ほど説明した通り、ドローンからカメラビューを取得し、それをウィンドウに表示させることである。カメラビューはドローンからのリアルタイム映像を動画として出力させるもので、その動画というのは、何枚もの画像をパラパラ表示させているものである。while 文内のプログラムを大まかに説明すると、ドローンのカメラから1枚画像を取得し、それをウィンドウに表示させるというものである。1枚手に入れてそれを画面に出す行動を while 文で回せば、動画として何枚も画像を更新し、リアルタイム映像として出力できるということである。では、一つづつ動画を手に入れる方法を見てみよう。
```python
        frame = drone.frame # このデータにドローンからのビデオデータが入っている。
```
この frame 変数として定義している drone.frame は、tello.py 内でエンコードされたドローンからのカメラ画像が格納されている。エンコードというのは、普通カメラから取得されるデータはただの数列の塊だが、これを人間にとってわかりやすいものに変換することをいう。つまり、変数 frame は、カメラデータのことを指す。
```python
        if frame is None or frame.size == 0: # フレームデータがない、またはフレームのサイズが0の時は無視する
            continue
```
次に、このようなif文があるのがわかるだろう。コメント文にも書かれている通り、frame 関数にデータが入っていない場合、もしくはそのデータのサイズが0であるとき、もう一度実行し直すというものである。どういうことかというと、ドローンとWi-Fiで通信している以上、稀にカメラデータがこないことがある。これが今ゆるラグというものなのだが、そのまま何にもないデータを流してしまうと、ウィンドウに何にもないデータが受け取られたとしてエラーが出てしまう。それを防ぐためにドローンデータがこなかった、またはサイズが0のデータ、つまり破損したデータが来たらこれを無視し、再度 frame 関数を定義するようにしているのである。
```python
        cv2.imshow("TELLO CAMERA VIEW",frame) # ビデオを画面出力
```
　次に取得したカメラデータ frame を会陰堂に表示するプログラムを書く。それが cv2.imshow() である。このプログラムは第1引数にウィンドウのタイトル。第2引数に出力させるデータを入れる。なので、今回は上のプログラムの通り、TELLO CAMERA VIEW というタイトルで frame 変数をウィンドウに出力させるようにする。こ雨することでウィンドウが生成され、ドローンから取得した1フレームを出力することができるようになる。
```python
key = cv2.waitKey(1)
        if key & 0xFF == 27: # ESC キーが押されたら終了
            break
```
次のプログラムでは、key という変数に何かよくわからないものを定義している。これは何何かというと、cv2.waitKey() といvう関数を変数に定義しているものだ。この cv2.waitKey() は、cv2.imshow() によって出力されたウィンドウに、何かキーボード入力を検知するというものである。この関数の引数は基本的に１にした方がいい。この引数に意味は、認識するキーボードの数で、引数を１にするということは、一個のキーを検知するということである。引数を2つにすると、二つのキーボードを同時に押さないと検知しないようになる。
<br>
　次の if 文にもややこしい文章がいっぱいあるのがわかるだろう。これの意味を示すと、もし、 key 変数がキーボード入力を検知し、なおかつ　0xFF によって取得されたキーボードアドレスが 27 なら、break するという意味である。この 0xFF というのは、簡単にいうとキーボードのなんのキーが押されたかを認識する謎の変数である。今はこんなものなんだなと思えばいい。そして、今回 ESC キーが押されたらこのプログラムを停止するようにしてあるため、sitearutame,0xFFとkey で ESC が押されたことを認識させる必要がある。ここで 0xFF で ESC が認識されるキーボードアドレスは 27 であるため、== 27 にしている。そしてif 文内の break で、永久ループから抜け出すようにしている。
```python
    drone.cap.release # ドローンからのビデオデータ更新を停止
    cv2.destroyAllWindows() # cv2 によって生成されたウィンドウを殺す
```
そして、永久ループから抜け出したら、この2つのプログラムを実行するようにする。この drone.cap.release というのは、ドローンからのカメラ映像を停止させるプログラムである。そして、cv2,destroyAllWindows でcv2によって生成されたウィンドウを削除する。これで sample_video.py の一連の解説は終わりである。
## 02 sample_videoControl.py を動かす
　sample_video.py の仕組みを理解できたら、これを応用したプログラムについて解説する。
<br>
　前回、 cv2.waitKey() と 0xFF について軽く学びました。この二つの関数を使うことで、cv2.imshow() によって生成されたウィンドウに対して、なんのキーボードが入力されたかを検出することができます。これを応用することで、ドローンをキーボードで操作することができます。試しに、以下のプログラムを実行してみましょう。
```bash
$ python3 sample_videoControl.py
```
カメラビューが表示されたら、カメラビューウィンドウを一回クリックしたのち、T キーを押してみよう。するとドローンが離陸する。そして L キーを押すと、ドローンは着陸する。こんな感じでドローンを操作して遊ぶことができるようになる。
## 03 チャレンジ ドローンをキーボードで操作してみよう！
